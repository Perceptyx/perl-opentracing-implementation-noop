image: ubuntu:bionic

variables:
  DEPENDENCIES: "331"

stages:
  - test
  - build

before_script:
  - echo "Before script installation"
  - apt update
  - apt install libdevel-cover-perl libtap-formatter-junit-perl libjson-xs-perl libtest-most-perl libtest-mockmodule-perl cpanminus make curl unzip -y
  - curl https://git.perceptyx.com/tvanhoesel/opentracing-perl/-/jobs/91758/artifacts/file/OpenTracing-Interface-0.02.tar.gz
  - unzip artifacts.zip
  - cd OpenTracing-Interface-0.02
  - perl Makefile.PL
  - make install
  - cd -

test:unit:
  stage: test
  script:
    - prove -MDevel::Cover -l lib -r t/
  coverage: /Totals+.+s(d+.d+?)$/

package:
  stage: build
  script:
    - cpanm --installdeps .
    - perl Makefile.PL
    - make dist
  artifacts:
    paths:
    - "*.tar.gz"
    expire_in: 1 week
